sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Icon","sap/m/Link","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/Dialog","sap/m/Button","sap/m/Text"],function(e,t,a,o,n,l,s,r,i,u){"use strict";return e.extend("com.digitech.digitechproject.controller.RequestForm",{onInit:function(){var e=new sap.ui.model.json.JSONModel({documentfiles:[]});this.getView().setModel(e);this.onReadSupplierSpendType();this.onReadNatureofActivity();this.onReadSector();this.onReadDepartments();var t=new Date;var a=new Date;a.setFullYear(t.getFullYear()+4);var o=this.byId("datePicker");o.setMinDate(t);o.setMaxDate(a);var e=new sap.ui.model.json.JSONModel({panCardValue:"",gstinValue:"",emailValue:"",numberValue:"",pan:[],gst:[]});this.getView().setModel(e)},onPanCardChange:function(e){var t=e.getSource();var a=t.getValue();var o=/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;if(o.test(a)){t.setValueState("Success")}else{t.setValueState("Error");t.setValueStateText("Invalid PAN format. Please enter a valid PAN.")}},onGSTINChange:function(e){var t=e.getSource();var a=t.getValue();var o=/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;var n=this.getView().getModel().getProperty("/panCardValue");if(o.test(a)){var l=a.substring(2,12);if(l===n){t.setValueState("Success")}else{t.setValueState("Error");t.setValueStateText("The PAN part of the GSTIN does not match the entered PAN.")}}else{t.setValueState("Error");t.setValueStateText("Invalid GSTIN format. Please enter a valid GSTIN.")}},onSubmitpan:function(){var e=this.byId("panInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("PAN Card number is valid: "+a)}else{t.show("Please enter a valid PAN Card number.")}},onSubmitgst:function(){var e=this.byId("gstinInput").getValue().trim();var a=this.getView().getModel("customerModel");var o=a.getProperty("/customers");var n=o.find(function(t){return t.GSTIN===e});if(n){var l=new sap.m.Dialog({title:"Customer Details",content:new sap.m.Text({text:"  Name: "+n.Name+"\n"+"  Address: "+n.Address+"\n"+"  Contact Number: "+n.ContactNumber}),beginButton:new sap.m.Button({text:"OK",press:function(){l.close()}}),afterClose:function(){l.destroy()}});l.open()}else{t.show("GSTIN not found!")}},onEmailChange:function(e){var t=e.getSource();var a=t.getValue();var o=/^[a-zA-Z0-9!#$%&'*+?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&'*+?^_`{|}~-]+)*@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])$/;if(o.test(a)){t.setValueState("Success")}else{t.setValueState("Error");t.setValueStateText("Invalid Email format. Please enter a valid Email.")}},onSubmitemail:function(){var e=this.byId("emailInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("Email is valid: "+a)}else{t.show("Please enter a valid email address.")}},onNumberChange:function(e){var t=e.getSource();var a=t.getValue();a=a.replace(/\D/g,"");if(a.length>10){a=a.substring(0,10)}t.setValue(a);if(a.length===10){t.setValueState("Success")}else{t.setValueState("Error");t.setValueStateText("Invalid Number. Please enter a valid Mobile Number.")}},onSubmitnumber:function(){var e=this.byId("numberInput");var a=e.getValue();if(e.getValueState()==="Success"){t.show("Number is valid: "+a)}else{t.show("Please enter a valid Mobile number.")}},onDownload:function(e){var t=e.getSource();var a=t.getCustomData()[0].getValue();var o=t.getText();var n=document.createElement("a");n.href=a;n.download=o;document.body.appendChild(n);n.click();document.body.removeChild(n)},onFormsubmit:function(){var e=this.getView();var a=this.getOwnerComponent().getModel();var o=true;var n={panattachment:e.byId("fileUploaderPan").getValue(),gstattachment:e.byId("fileUploaderGst").getValue()};var l={DigressionVendorCodeVal:"2025-09-30",IsRelPartyVCode:true,SpendType:"Indirect",NatureOfActivity:"Material",Sector:["IT","Manufacturing"],FunAndSubfun:["Finance","HR"],PANCardNo:"ABCDE1234F",GSTIN:"27ABCDE1234F1Z5",SFullName:"ABC Corp Pvt. Ltd.",STradeNameGST:"ABC Trade",SAddress:"123, Example Street, City, State",SAddressGST:"123, Example Street, City, State",PriContactFName:"Sumit",PriContactLName:"Doe",PriContactEmail:"john.doe@example.com",PriContactMNumber:"1234567890"};a.setUseBatch(false);var e=this;a.create("/supplierReqSrv",l,{method:"POST",success:function(a){t.show("Form submitted successfully."+a.ID);console.log(a.ID);this.onUploadFile(a.ID);console.log("----------\x3eUpload");e.clearFormFields()}.bind(this),error:function(){t.show("Error while submitting the Form.")}})},onUploadFile:function(e){console.log("On Upload file---------\x3e");const a=(e,a)=>{e.forEach(e=>{console.log("Control reached!!!");var o={Req_Supplier_ID:a,Doc_Type:"PAN",Attachment_ID:e.attachmentId,fileName:e.fileName,mediaType:e.fileType,content:e.fileContent,Doc_Type:e.Doc_Type};console.log(o);var n=this.getOwnerComponent().getModel();n.setUseBatch(false);n.create("/SReqattachmentsSrv",o,{method:"POST",success:function(e){t.show("Attachments uploaded successfully: "+e.ID)}.bind(this),error:function(){t.show("Error while Uploading the Attachments.")}})})};var o=this.getView().getModel();var n=o.getProperty("/documentFiles");console.log(n.pan);console.log(n.gst);var l=n.pan.concat(n.gst);console.log(l);console.log(`++++++++++ ${l}++++++++++`);a(l,e)},onFileUpload:function(e){var a=e.getSource();var o=a.getValue();var n=a.oFileUpload.files[0];if(o){a.setValueState(sap.ui.core.ValueState.None)}if(n){var l=n.name;var s=l.split(".").pop();var r=new FileReader;var i=this;r.onload=function(e){var o=e.target.result;console.log("Base64 File URL: ",o);var n=i.getView().getModel();var r=n.getProperty("/documentFiles")||{pan:[],gst:[],cin:[]};var u=r.pan.length+1;var d=r.gst.length+1;var c=r.cin.length+1;var p=a.getId();var g="";var m="";if(p.includes("fileUploaderPan")){g="PAN";m=u;r.pan.push({fileName:l,fileUrl:o,fileContent:o,fileType:s,Doc_Type:"PAN",attachmentId:m})}else if(p.includes("fileUploaderGst")){g="GST";m=d;r.gst.push({fileName:l,fileUrl:o,fileContent:o,fileType:s,Doc_Type:"GST",attachmentId:m})}else if(p.includes("fileUploaderCin")){g="CIN";m=c;r.cin.push({fileName:l,fileUrl:o,fileContent:o,fileType:s,Doc_Type:"CIN",attachmentId:m})}n.setProperty("/documentFiles",r);console.log("Updated /documentFiles:",n.getProperty("/documentFiles"));t.show(g+" file "+l+" uploaded successfully.");n.refresh(true)};r.readAsDataURL(n)}},formatAttachmentButtonText:function(e,t){e=e||[];return"View Attachments ("+e.length+")"},onOpenDialog:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.digitech.digitechproject.view.fragment.uploadfile",this);this.getView().addDependent(this._oDialog)}var t=this.getView().getModel();var a=t.getProperty("/documentFiles/"+e)||[];var o=new sap.ui.model.json.JSONModel({documentFiles:a});this._oDialog.setModel(o);this._oDialog.data("documentType",e);this._oDialog.open()},onCloseDialog:function(){if(this._oDialog){this._oDialog.close()}},onDownloadFile:function(e){const a=e.getSource().data("fileName");const o=this._oDialog.data("documentType");var n=this.getView().getModel();var l=n.getProperty("/documentFiles/"+o);var s=l.find(e=>e.fileName===a);console.log("Selected File: ",s);if(s&&s.fileContent){const e=this._base64ToBlob(s.fileContent);const t=document.createElement("a");t.href=URL.createObjectURL(e);t.download=a;t.click()}else{t.show("File not found or missing content.")}},onDeleteFile:function(e){const a=e.getSource().data("fileName");const o=this._oDialog.data("documentType");sap.m.MessageBox.confirm(`Are you sure you want to delete the file "${a}"?`,{onClose:function(e){if(e==="OK"){const e=this.getView().getModel();const n=e.getProperty("/documentFiles/"+o);const l=n.filter(e=>e.fileName!==a);e.setProperty("/documentFiles/"+o,l);t.show(`File "${a}" deleted successfully.`);this.onCloseDialog()}}.bind(this)})},_base64ToBlob:function(e){if(e.startsWith("data:")){e=e.split(",")[1]}console.log("Base64 String: ",e);try{const t=atob(e);const a=[];for(let e=0;e<t.length;e+=512){const o=t.slice(e,e+512);const n=new Array(o.length);for(let e=0;e<o.length;e++){n[e]=o.charCodeAt(e)}const l=new Uint8Array(n);a.push(l)}return new Blob(a,{type:"application/octet-stream"})}catch(e){console.error("Base64 decoding failed: ",e);return null}},handleLiveChange:function(e){var t=e.getSource();var a=t.getValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleComboBoxChange:function(e){var t=e.getSource();var a=t.getSelectedKey();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleDateChange:function(e){var t=e.getSource();var a=t.getDateValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleFileChange:function(e){var t=e.getSource();var a=t.getValue();if(a){t.setValueState(sap.ui.core.ValueState.None)}},handleMultiComboBoxChange:function(e){var t=e.getSource();var a=t.getSelectedItems();if(a.length>0){t.setValueState(sap.ui.core.ValueState.None)}},clearFormFields:function(){var e=this.getView();e.byId("datePicker").setDateValue(null);e.byId("radioGroup").setSelectedButton(null);e.byId("supplierSpendType").setSelectedKey("");e.byId("NatureofActivity").setSelectedKey("");e.byId("sectorComboBox").setSelectedKeys([]);e.byId("childMultiComboBox").setSelectedKeys([]);e.byId("panInput").setValue("");e.byId("fileUploaderPan").setValue("");e.byId("fileUploaderGst").setValue("");e.byId("gstinInput").setValue("");e.byId("SupplierNameInput").setValue("");e.byId("SuppliertradeNameInput").setValue("");e.byId("SupplierAddressInput").setValue("");e.byId("SupplierAddressgstInput").setValue("");e.byId("PrimaryFirstnameInput").setValue("");e.byId("PrimaryLastnameInput").setValue("");e.byId("emailInput").setValue("");e.byId("numberInput").setValue("")},onReadSector:function(){console.log("I am sector srv");var e=this;var t=this.getOwnerComponent().getModel();t.read("/SectorSrv",{success:function(t){console.log(t);var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("sectorComboBox").setModel(a)},error:function(e){console.log(e)}})},onReadNatureofActivity:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/NatureOfActivitySrv",{success:function(t){console.log(t);var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("NatureofActivity").setModel(a)},error:function(e){console.log(e)}})},onReadSupplierSpendType:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/SupplierSpendTypeSrv",{success:function(t){console.log(t);var a=new sap.ui.model.json.JSONModel(t);e.getView().byId("supplierSpendType").setModel(a)},error:function(e){console.log(e)}})},onSave:function(){var e=this.getView();var a={validity:e.byId("datePicker").getDateValue(),relatedParty:e.byId("radioGroup").getSelectedButton().getText(),supplierSpendType:e.byId("supplierSpendType").getSelectedKey(),natureOfActivity:e.byId("NatureofActivity").getSelectedKey(),sector:e.byId("sectorComboBox").getSelectedKeys().join(", "),FunctionandSubfunction:e.byId("childMultiComboBox").getSelectedKeys(),panCardNumber:e.byId("panInput").getValue(),gstinNumber:e.byId("gstinInput").getValue(),supplierFullName:e.byId("SupplierNameInput").getValue(),supplierTradeName:e.byId("SuppliertradeNameInput").getValue(),supplierAddress:e.byId("SupplierAddressInput").getValue(),supplierGstAddress:e.byId("SupplierAddressgstInput").getValue(),primaryFirstName:e.byId("PrimaryFirstnameInput").getValue(),primaryLastName:e.byId("PrimaryLastnameInput").getValue(),primaryEmail:e.byId("emailInput").getValue(),primaryPhone:e.byId("numberInput").getValue()};var o=JSON.stringify(a);localStorage.setItem("formData",o);console.log(a);t.show("Form data saved successfully in local storage.")},onReadDepartments:function(){var e=this;var t=this.getOwnerComponent().getModel();t.read("/departmentsSrv",{success:function(t){console.log("Departments Data:",t);var a=new sap.ui.model.json.JSONModel(t);e.getView().setModel(a,"departmentsModel");var o=e.getView().byId("FunctionandSubfunctionComboBox");var n=o.getItems();if(n&&n.length>0){o.setSelectedItem(n[0]);e.onDepartmentChange({getParameter:function(){return n[0]}})}},error:function(e){console.log("Error fetching departments data:",e)}})},onDepartmentChange:function(e){var t=this;var a=e.getParameter("selectedItem");console.log("Selected Item:",a);if(a){var o=a.getBindingContext("departmentsModel").getObject();console.log("Selected Department:",o);if(o.Functions&&o.Functions.length>0){console.log("Functions:",o.Functions);var n=new sap.ui.model.json.JSONModel({Functions:o.Functions});t.getView().byId("childMultiComboBox").setModel(n,"functionsModel")}else{console.log("No functions available for the selected department.")}}}})});
//# sourceMappingURL=RequestForm.controller.js.map